name: E2E Tests

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    tags:
      - 'v*-*'  # Pre-release tags like v1.0.0-beta.1

jobs:
  e2e:
    runs-on: self-hosted
    # Prevent untrusted code from running on self-hosted runner.
    # Preemptive guard: workflow doesn't currently trigger on PRs, but this
    # protects the self-hosted runner if PR triggers are added later.
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    env:
      E2E_HOST: ${{ secrets.E2E_HOST }}
      E2E_USER: ${{ secrets.E2E_USER }}
      E2E_PATH: ${{ secrets.E2E_PATH }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 25
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install modern C++ compiler
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq g++-10
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-10 100
      - run: bun install

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.E2E_SSH_KEY }}" > ~/.ssh/e2e_key
          chmod 600 ~/.ssh/e2e_key
          ssh-keyscan -H $E2E_HOST >> ~/.ssh/known_hosts 2>/dev/null
          echo "E2E_SSH_KEY_PATH=$HOME/.ssh/e2e_key" >> $GITHUB_ENV

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/e2e_key -o ConnectTimeout=10 $E2E_USER@$E2E_HOST echo "SSH connection successful"
        continue-on-error: true

      - name: Run E2E tests
        run: bun test:e2e

      - name: Cleanup remote test data
        if: always()
        run: |
          ssh -i ~/.ssh/e2e_key $E2E_USER@$E2E_HOST "rm -rf ~/skybox-e2e-tests/run-* 2>/dev/null || true"
        continue-on-error: true

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/e2e_key
          rm -f ~/.ssh/known_hosts
